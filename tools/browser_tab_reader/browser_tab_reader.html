<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firefox Tab Reader</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1, h2, h3 {
            color: #333;
        }
        .container {
            margin-bottom: 30px;
        }
        .instructions {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .dictionary-tabs {
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .buttons {
            margin: 20px 0;
        }
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        #status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #dff0d8;
            color: #3c763d;
        }
        .error {
            background-color: #f2dede;
            color: #a94442;
        }
        .warning {
            background-color: #fcf8e3;
            color: #8a6d3b;
        }
        .hidden {
            display: none;
        }
        #searchInput {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        /* Bilingual styling */
        .guide-english, .guide-chinese {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
        }
        
        .guide-english {
            background-color: #f0f8ff;
        }
        
        .guide-chinese {
            background-color: #fff0f0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Firefox Tab Reader / Firefox 标签页阅读器</h1>
        <h2>Browser Tab Dictionary Tool / 浏览器标签页词典工具</h2>
        
        <div class="instructions">
            <h3>Instructions / 使用说明:</h3>
            
            <div class="guide-english">
                <p>This tool extracts all your open Firefox tabs and identifies dictionary websites. It works directly in your browser without requiring any installation or access to your Firefox profile directory.</p>
                <ol>
                    <li>Click the "Read Tabs" button below to extract all your currently open tabs.</li>
                    <li>The tool will identify dictionary websites and display them in a table.</li>
                    <li>You can save the results as a JSON file for use with gist-dictionary.</li>
                </ol>
                <p><strong>Note:</strong> This tool only works when opened in Firefox, as it needs access to your current browser tabs.</p>
            </div>
            
            <div class="guide-chinese">
                <p>此工具提取您所有打开的Firefox标签页并识别词典网站。它直接在您的浏览器中工作，无需安装或访问您的Firefox配置文件目录。</p>
                <ol>
                    <li>点击下方的"读取标签页"按钮以提取您当前打开的所有标签页。</li>
                    <li>该工具将识别词典网站并在表格中显示它们。</li>
                    <li>您可以将结果保存为JSON文件，以便与gist-dictionary一起使用。</li>
                </ol>
                <p><strong>注意：</strong>此工具仅在Firefox中打开时有效，因为它需要访问您当前的浏览器标签页。</p>
            </div>
        </div>
        
        <div class="buttons">
            <button id="readTabsBtn">Read Tabs / 读取标签页</button>
            <button id="saveJsonBtn" disabled>Save as JSON / 保存为JSON</button>
            <button id="copyJsonBtn" disabled>Copy JSON / 复制JSON</button>
        </div>
        
        <div id="status" class="hidden"></div>
        
        <div class="dictionary-tabs hidden" id="resultsContainer">
            <h3>Dictionary Tabs / 词典标签页</h3>
            <p>Found <span id="dictTabCount">0</span> dictionary tabs out of <span id="totalTabCount">0</span> total tabs. / 在总共 <span id="totalTabCount">0</span> 个标签页中找到 <span id="dictTabCount">0</span> 个词典标签页。</p>
            
            <input type="text" id="searchInput" placeholder="Search tabs... / 搜索标签页...">
            
            <table id="tabsTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Title / 标题</th>
                        <th>URL / 网址</th>
                        <th>Dictionary / 词典</th>
                        <th>Search Term / 搜索词</th>
                    </tr>
                </thead>
                <tbody id="tabsTableBody">
                    <!-- Table rows will be added here dynamically -->
                </tbody>
            </table>
        </div>
        
        <div id="jsonOutput" class="hidden">
            <h3>JSON Output / JSON 输出</h3>
            <pre id="jsonContent"></pre>
        </div>
        
        <div id="permissionsGuide" class="hidden instructions">
            <h3>How to Enable Tabs Permission in Firefox / 如何在Firefox中启用标签页权限</h3>
            
            <div class="guide-english">
                <h4>English Instructions:</h4>
                <ol>
                    <li>Create a Firefox Extension:
                        <ol>
                            <li>Create a new folder on your computer for the extension</li>
                            <li>Inside this folder, create a file named <code>manifest.json</code> with the following content:
                                <pre>
{
  "manifest_version": 2,
  "name": "Tab Reader",
  "version": "1.0",
  "description": "Reads browser tabs",
  "permissions": ["tabs"],
  "browser_action": {
    "default_title": "Tab Reader"
  }
}
                                </pre>
                            </li>
                        </ol>
                    </li>
                    <li>Load the Extension in Firefox:
                        <ol>
                            <li>Open Firefox and type <code>about:debugging</code> in the address bar</li>
                            <li>Click on "This Firefox" in the left sidebar</li>
                            <li>Click "Load Temporary Add-on..."</li>
                            <li>Navigate to your extension folder and select the <code>manifest.json</code> file</li>
                        </ol>
                    </li>
                    <li>Use This Tool:
                        <ol>
                            <li>After installing the extension, refresh this page</li>
                            <li>Click the "Read Tabs" button again</li>
                            <li>The tool should now be able to access your tabs</li>
                        </ol>
                    </li>
                </ol>
                <p><strong>Note:</strong> This temporary extension will be removed when you close Firefox.</p>
            </div>
            
            <div class="guide-chinese">
                <h4>中文说明：</h4>
                <ol>
                    <li>创建Firefox扩展：
                        <ol>
                            <li>在您的计算机上为扩展创建一个新文件夹</li>
                            <li>在此文件夹中，创建一个名为<code>manifest.json</code>的文件，内容如下：
                                <pre>
{
  "manifest_version": 2,
  "name": "Tab Reader",
  "version": "1.0",
  "description": "Reads browser tabs",
  "permissions": ["tabs"],
  "browser_action": {
    "default_title": "Tab Reader"
  }
}
                                </pre>
                            </li>
                        </ol>
                    </li>
                    <li>在Firefox中加载扩展：
                        <ol>
                            <li>打开Firefox并在地址栏中输入<code>about:debugging</code></li>
                            <li>点击左侧边栏中的"此Firefox"</li>
                            <li>点击"临时载入附加组件..."</li>
                            <li>导航到您的扩展文件夹并选择<code>manifest.json</code>文件</li>
                        </ol>
                    </li>
                    <li>使用此工具：
                        <ol>
                            <li>安装扩展后，刷新此页面</li>
                            <li>再次点击"读取标签页"按钮</li>
                            <li>该工具现在应该能够访问您的标签页</li>
                        </ol>
                    </li>
                </ol>
                <p><strong>注意：</strong>当您关闭Firefox时，此临时扩展将被移除。</p>
            </div>
        </div>
    </div>

    <script>
        // Dictionary site patterns
        const dictionarySites = [
            { domain: "dictionary.com", pattern: /\/browse\/([^\/\?#]+)/ },
            { domain: "merriam-webster.com", pattern: /\/dictionary\/([^\/\?#]+)/ },
            { domain: "vocabulary.com", pattern: /\/dictionary\/([^\/\?#]+)/ },
            { domain: "thefreedictionary.com", pattern: /\/([^\/\?#]+)$/ },
            { domain: "dictionary.cambridge.org", pattern: /\/dictionary\/[^\/]+\/([^\/\?#]+)/ },
            { domain: "oxforddictionaries.com", pattern: /\/definition\/([^\/\?#]+)/ },
            { domain: "collinsdictionary.com", pattern: /\/dictionary\/[^\/]+\/([^\/\?#]+)/ },
            { domain: "macmillandictionary.com", pattern: /\/dictionary\/[^\/]+\/([^\/\?#]+)/ },
            { domain: "ldoceonline.com", pattern: /\/dictionary\/[^\/]+\/([^\/\?#]+)/ },
            { domain: "lexico.com", pattern: /\/definition\/([^\/\?#]+)/ },
            { domain: "etymonline.com", pattern: /\/word\/([^\/\?#]+)/ },
            { domain: "wordreference.com", pattern: /\/([^\/\?#]+)$/ },
            { domain: "urbandictionary.com", pattern: /\/define\.php\?term=([^&]+)/ },
            { domain: "wiktionary.org", pattern: /\/wiki\/([^:]+)$/ },
            { domain: "thesaurus.com", pattern: /\/browse\/([^\/\?#]+)/ }
        ];

        // Global variables
        let allTabs = [];
        let dictionaryTabs = [];

        // DOM elements
        const readTabsBtn = document.getElementById('readTabsBtn');
        const saveJsonBtn = document.getElementById('saveJsonBtn');
        const copyJsonBtn = document.getElementById('copyJsonBtn');
        const statusDiv = document.getElementById('status');
        const resultsContainer = document.getElementById('resultsContainer');
        const dictTabCount = document.getElementById('dictTabCount');
        const totalTabCount = document.getElementById('totalTabCount');
        const tabsTableBody = document.getElementById('tabsTableBody');
        const jsonContent = document.getElementById('jsonContent');
        const jsonOutput = document.getElementById('jsonOutput');
        const searchInput = document.getElementById('searchInput');

        // Check if running in Firefox
        function isFirefox() {
            return navigator.userAgent.includes('Firefox');
        }

        // Show status message
        function showStatus(message, type) {
            statusDiv.textContent = message;
            statusDiv.className = type;
            statusDiv.classList.remove('hidden');
        }
        
        // Bilingual status messages
        const statusMessages = {
            readingTabs: {
                en: 'Reading tabs...',
                zh: '正在读取标签页...'
            },
            requiresPermission: {
                en: 'This tool requires Firefox with the "tabs" permission. Please see instructions below.',
                zh: '此工具需要具有"tabs"权限的Firefox。请参阅下面的说明。'
            },
            onlyFirefox: {
                en: 'This tool only works in Firefox. Please open it in Firefox browser.',
                zh: '此工具仅适用于Firefox。请在Firefox浏览器中打开它。'
            },
            foundTabs: {
                en: (dictCount, totalCount) => `Found ${dictCount} dictionary tabs out of ${totalCount} total tabs.`,
                zh: (dictCount, totalCount) => `在总共 ${totalCount} 个标签页中找到 ${dictCount} 个词典标签页。`
            },
            jsonSaved: {
                en: 'JSON file saved successfully!',
                zh: 'JSON文件保存成功！'
            },
            jsonCopied: {
                en: 'JSON copied to clipboard!',
                zh: 'JSON已复制到剪贴板！'
            }
        }

        // Extract search term from URL
        function extractSearchTerm(url, domain) {
            const matchingSite = dictionarySites.find(site => url.includes(site.domain));
            if (!matchingSite) return null;
            
            try {
                const urlObj = new URL(url);
                const match = urlObj.pathname.match(matchingSite.pattern);
                if (match && match[1]) {
                    return decodeURIComponent(match[1].replace(/\+/g, ' '));
                }
                
                // Check for query parameters
                const searchParams = urlObj.searchParams;
                for (const param of ['q', 'query', 'word', 'term', 'search']) {
                    if (searchParams.has(param)) {
                        return searchParams.get(param);
                    }
                }
            } catch (e) {
                console.error("Error parsing URL:", e);
            }
            
            return null;
        }

        // Check if URL is from a dictionary site
        function isDictionarySite(url) {
            const urlObj = new URL(url);
            let domain = urlObj.hostname.toLowerCase();
            
            // Remove 'www.' prefix if present
            if (domain.startsWith('www.')) {
                domain = domain.substring(4);
            }
            
            return dictionarySites.some(site => domain.includes(site.domain));
        }

        // Get dictionary name from URL
        function getDictionaryName(url) {
            const urlObj = new URL(url);
            let domain = urlObj.hostname.toLowerCase();
            
            // Remove 'www.' prefix if present
            if (domain.startsWith('www.')) {
                domain = domain.substring(4);
            }
            
            // Extract the main dictionary name
            for (const site of dictionarySites) {
                if (domain.includes(site.domain)) {
                    // Capitalize first letter and format nicely
                    const name = site.domain.split('.')[0];
                    return name.charAt(0).toUpperCase() + name.slice(1);
                }
            }
            
            return "Unknown";
        }

        // Read tabs from browser
        async function readTabs() {
            if (!isFirefox()) {
                showStatus(`${statusMessages.onlyFirefox.en}\n${statusMessages.onlyFirefox.zh}`, 'error');
                return;
            }
            
            try {
                showStatus(`${statusMessages.readingTabs.en}\n${statusMessages.readingTabs.zh}`, 'warning');
                
                // Check if browser.tabs API is available (Firefox only)
                if (typeof browser !== 'undefined' && browser.tabs) {
                    // Get all tabs from all windows
                    const tabs = await browser.tabs.query({});
                    processTabsData(tabs);
                } else {
                    // Fallback method for Firefox without extension permissions
                    showStatus(`${statusMessages.requiresPermission.en}\n${statusMessages.requiresPermission.zh}`, 'error');
                    document.getElementById('permissionsGuide').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error reading tabs:', error);
                showStatus(`Error reading tabs: ${error.message}\n读取标签页时出错：${error.message}`, 'error');
            }
        }

        // Process tabs data
        function processTabsData(tabs) {
            allTabs = tabs.map(tab => ({
                title: tab.title,
                url: tab.url,
                favIconUrl: tab.favIconUrl,
                windowId: tab.windowId,
                index: tab.index,
                active: tab.active
            }));
            
            // Filter dictionary tabs
            dictionaryTabs = allTabs.filter(tab => isDictionarySite(tab.url))
                .map(tab => {
                    const dictionaryName = getDictionaryName(tab.url);
                    const searchTerm = extractSearchTerm(tab.url, dictionaryName);
                    
                    return {
                        ...tab,
                        dictionary: dictionaryName,
                        search_term: searchTerm
                    };
                });
            
            // Update UI
            dictTabCount.textContent = dictionaryTabs.length;
            totalTabCount.textContent = allTabs.length;
            
            // Display results
            displayResults();
            
            // Enable buttons
            saveJsonBtn.disabled = false;
            copyJsonBtn.disabled = false;
            
            const enMessage = statusMessages.foundTabs.en(dictionaryTabs.length, allTabs.length);
            const zhMessage = statusMessages.foundTabs.zh(dictionaryTabs.length, allTabs.length);
            showStatus(`${enMessage}\n${zhMessage}`, 'success');
            resultsContainer.classList.remove('hidden');
            
            // Generate JSON
            generateJson();
        }

        // Display results in table
        function displayResults() {
            tabsTableBody.innerHTML = '';
            
            dictionaryTabs.forEach((tab, index) => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${escapeHtml(tab.title)}</td>
                    <td><a href="${tab.url}" target="_blank">${escapeHtml(tab.url)}</a></td>
                    <td>${escapeHtml(tab.dictionary)}</td>
                    <td>${escapeHtml(tab.search_term || 'N/A')}</td>
                `;
                
                tabsTableBody.appendChild(row);
            });
        }

        // Generate JSON output
        function generateJson() {
            const jsonData = dictionaryTabs.map(tab => ({
                title: tab.title,
                url: tab.url,
                dictionary: tab.dictionary,
                search_term: tab.search_term
            }));
            
            const jsonString = JSON.stringify(jsonData, null, 2);
            jsonContent.textContent = jsonString;
            jsonOutput.classList.remove('hidden');
        }

        // Save JSON to file
        function saveJson() {
            const jsonData = dictionaryTabs.map(tab => ({
                title: tab.title,
                url: tab.url,
                dictionary: tab.dictionary,
                search_term: tab.search_term
            }));
            
            const jsonString = JSON.stringify(jsonData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'dictionary_tabs.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showStatus(`${statusMessages.jsonSaved.en}\n${statusMessages.jsonSaved.zh}`, 'success');
        }

        // Copy JSON to clipboard
        function copyJson() {
            const jsonData = dictionaryTabs.map(tab => ({
                title: tab.title,
                url: tab.url,
                dictionary: tab.dictionary,
                search_term: tab.search_term
            }));
            
            const jsonString = JSON.stringify(jsonData, null, 2);
            
            navigator.clipboard.writeText(jsonString)
                .then(() => {
                    showStatus(`${statusMessages.jsonCopied.en}\n${statusMessages.jsonCopied.zh}`, 'success');
                })
                .catch(err => {
                    console.error('Error copying to clipboard:', err);
                    showStatus(`Error copying to clipboard: ${err.message}\n复制到剪贴板时出错：${err.message}`, 'error');
                });
        }

        // Filter table based on search input
        function filterTable() {
            const searchTerm = searchInput.value.toLowerCase();
            const rows = tabsTableBody.getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const cells = row.getElementsByTagName('td');
                let found = false;
                
                for (let j = 0; j < cells.length; j++) {
                    const cellText = cells[j].textContent.toLowerCase();
                    if (cellText.includes(searchTerm)) {
                        found = true;
                        break;
                    }
                }
                
                row.style.display = found ? '' : 'none';
            }
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Event listeners
        readTabsBtn.addEventListener('click', readTabs);
        saveJsonBtn.addEventListener('click', saveJson);
        copyJsonBtn.addEventListener('click', copyJson);
        searchInput.addEventListener('input', filterTable);

        // Check if Firefox on page load
        document.addEventListener('DOMContentLoaded', () => {
            if (!isFirefox()) {
                showStatus(`${statusMessages.onlyFirefox.en}\n${statusMessages.onlyFirefox.zh}`, 'error');
                readTabsBtn.disabled = true;
            }
        });
    </script>
</body>
</html>